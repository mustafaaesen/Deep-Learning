# -*- coding: utf-8 -*-
"""Deep Learning Project-2 Get a Loan? .ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jOEAFl9qV1Eh1OIewFc2xG4DQjr8JAOY
"""

#Proje 2 Kredi Alabilir mi?

"""
Hedef:
--->KiÅŸinin gelir,yaÅŸ,borÃ§ gibi Ã¶zelliklerine bakarak
kredi alabilir mi(1) veya alamaz mÄ±(0) tahmini yapmak.

Bu proje Yapay sinir aÄŸlarÄ± ile Ã§Ã¶zeceÄŸimiz binary sÄ±nÄ±flandÄ±rma
problemidir.

TEKNOLOJÄ°LER
-->Pandas/Numpy -> Veri Ä°ÅŸleme
-->Scikit_learn ->veri seti, Ã¶n iÅŸleme, deÄŸerlendirme
-->Tensorflow/Keras -> Yapay Sinir AÄŸÄ± modeli
-->Matplotlib/Seaborn ->Grafik


"""

#GEREKLÄ° KÃœTÃœPHANELER

import pandas as pd
import numpy as np

import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
#veri seti Ã¶n iÅŸleme

import tensorflow as tf
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Dense
#derin Ã¶ÄŸrenme iÃ§in gerekli kÃ¼tÃ¼phaneler

from sklearn.metrics import accuracy_score,confusion_matrix, classification_report
#DeÄŸerlendirme iÃ§in

from google.colab import files

# Dosya yÃ¼kleme penceresini aÃ§ar
uploaded = files.upload()

"""
Elimizde mÃ¼ÅŸterilerin
| SÃ¼tun AdÄ±             | AÃ§Ä±klama                        |
| --------------------- | ------------------------------- |
| ID                    | MÃ¼ÅŸteri ID'si                   |
| CODE\_GENDER          | Cinsiyet                        |
| FLAG\_OWN\_CAR        | Araba sahibi mi?                |
| FLAG\_OWN\_REALTY     | Ev sahibi mi?                   |
| CNT\_CHILDREN         | Ã‡ocuk sayÄ±sÄ±                    |
| AMT\_INCOME\_TOTAL    | Gelir                           |
| NAME\_INCOME\_TYPE    | Gelir tÃ¼rÃ¼ (Ã§alÄ±ÅŸan, emekli...) |
| NAME\_EDUCATION\_TYPE | EÄŸitim durumu                   |
| NAME\_FAMILY\_STATUS  | Medeni durumu                   |
| DAYS\_BIRTH           | DoÄŸum gÃ¼nÃ¼ (negatif deÄŸer)      |
| DAYS\_EMPLOYED        | Ã‡alÄ±ÅŸma sÃ¼resi                  |
| ...                   | vs.                             |


gibi verilerini tutan application.record.csv ve


| SÃ¼tun AdÄ±       | AÃ§Ä±klama                                                           |
| --------------- | ------------------------------------------------------------------ |
| ID              | MÃ¼ÅŸteri ID'si                                                      |
| MONTHS\_BALANCE | Kredi geÃ§miÅŸi ay bilgisi                                           |
| STATUS          | Kredi durumu (0: zamanÄ±nda, 1â€“5: gecikme, C: kapalÄ±, X: bilgi yok) |


mÃ¼ÅŸterilerin daha Ã¶nce kredi kullnaÄ±p kullanmadÄ±ÄŸÄ±yla ilgili credit_record.csv

olmak Ã¼zere iki veri seti mevcut Ã¶nce bu veri setlerini  iÃ§eri alÄ±p Ã¶niÅŸleme s
sÄ±rasÄ±nda bilrÅŸetirmeye Ã§alÄ±ÅŸacaÄŸÄ±z





"""

#veri setlerini dataframe e Ã§ekme

import pandas as pd

app_df = pd.read_csv("application_record.csv")
#mÃ¼ÅŸteri bilgilerinin atanmasÄ±

credit_df = pd.read_csv("credit_record.csv")
#daha Ã¶nce kullandÄ±ysa kredi bilgileri


print("Application Veri Seti:")
#ilk  bir kaÃ§ satÄ±rÄ± gÃ¶rÃ¼ntÃ¼leme
display(app_df.head())

print("Credit Veri Seti:")
display(credit_df.head())

"""
credit_record iÃ§erisnde dÃ¼zenlemeler yapaacÄ±ÄŸz

en riskli durumun tespiti

gecikme yoksa 1 kredi alabilir varsa 0 yÃ¼ksek riksli ÅŸeklinde
etiket sÃ¼tunu oluÅŸturacaÄŸÄ±z(TARGET)

"""
# Ã–nce kredi durumundaki eÅŸsiz deÄŸerleri gÃ¶relim
print("EÅŸsiz kredi durumlarÄ± (STATUS):", credit_df["STATUS"].unique())

#Her mÃ¼ÅŸteri iÃ§in en kÃ¶tÃ¼ durumlarÄ±n bulunup etiketlenmesi




status_summary = credit_df.groupby("ID")["STATUS"].apply(lambda x: ''.join(set(x)))
#her id iÃ§in en kÃ¶tÃ¼ durumu bulur daha sonra iÃ§lerinden en kÃ¶tÃ¼sÃ¼nÃ¼ bulur

#gecikmeli Ã¶demesi olup olmadÄ±ÄŸÄ±na bakan fonksiyon
def is_good_credit(statur_str):

  for risk in ['1','2','3','4','5']:

    if risk in statur_str:# riskli mÃ¼ÅŸteri tespiti

      return 0

  return 1 #gÃ¼venilir mÃ¼ÅŸteri


credit_status = status_summary.apply(is_good_credit).reset_index()
#tÃ¼m mÃ¼ÅŸterilere etiket atÄ±lmasÄ±

credit_status.columns = ["ID","TARGET"]


credit_status.head()

#Her mÃ¼ÅŸterinin kredi durumu target sÃ¼tunu oluÅŸturulup sonuÃ§lar yazÄ±ldÄ±

#Setlerin BirleÅŸtirilmesi

merged_df = pd.merge(app_df, credit_status, on = "ID")
# id lere gÃ¶re veri setlerinin birleÅŸtirilmesi

merged_df.head()

#Kontrol: Hedef DeÄŸerlerin daÄŸÄ±lÄ±mÄ±

#burada veri setinden bozukluk gelip gelmediÄŸini kontrol edeceÄŸiz
#saÄŸlÄ±klÄ± Ã§alÄ±ÅŸma iÃ§in Ã¶nemlidir

merged_df["TARGET"].value_counts()
# 0 = Riskli mÃ¼ÅŸteri, 1 = GÃ¼venilir mÃ¼ÅŸteri

#Ã–NÄ°ÅLEME ve VERÄ° SETÄ° TEMÄ°ZLÄ°ÄÄ°

columns_to_drop = [


    'ID',
    'FLAG_MOBIL',
    'FLAG_WORK_PHONE',
    'FLAG_PHONE',
    'FLAG_EMAIL',
    'OCCUPATION-TYPE'
]

merged_df.drop(columns = [col for col in columns_to_drop if col in merged_df.columns],axis=1,inplace=True)

# SÃ¼tunlarÄ± dÃ¼ÅŸÃ¼rme

merged_df.info()

#Kategorik SÃ¼tunlarÄ± SayÄ±sala Ã‡evirme(Encoding)

categorical_cols = merged_df.select_dtypes(include='object').columns.tolist()
#Kategorik verilerin seÃ§ilmesi

merged_df_encoded = pd.get_dummies(merged_df,columns=categorical_cols, drop_first=True)
#encoding uygulama

print("Yeni sÃ¼tun sayÄ±sÄ±:",merged_df_encoded.shape[1])
merged_df_encoded.head()

#SAyÄ±sal verilerin Ã¶lÃ§eklenmesi

from sklearn.preprocessing import StandardScaler

X= merged_df_encoded.drop("TARGET",axis=1)
y=merged_df_encoded["TARGET"]
#hedef deÄŸiÅŸkenlerin atanmasÄ±

from sklearn.model_selection import train_test_split

X_train, X_test, y_train, y_test= train_test_split(X,y, test_size=0.2, random_state=42)
#eÄŸtitim ve test verisi ayarlanmasÄ±

scaler=StandardScaler()

X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)
#sayÄ±sal deÄŸerlerin Ã¶lÃ§eklenmesi

#Model TanÄ±mlama

from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Dense


model = Sequential()
#katmanlÄ± modeller oluÅŸturma

model.add(Dense(64, activation='relu', input_shape=(X_train_scaled.shape[1],)))
#giriÅŸ gizli katmanÄ±

model.add(Dense(32, activation='relu'))
#ikinci gizli katman

model.add(Dense(16,activation='relu'))
#Ã¼Ã§Ã¼ncÃ¼ gizli katman

model.add(Dense(1,activation='sigmoid'))
#Ã§Ä±ktÄ± katmanÄ±  binary classifitaion-->sigmoid

#Modeli Derleme

model.compile(

    optimizer='adam',    #aÄŸÄ±rlÄ±klarÄ± her seferinde gÃ¼ncellyen algoritma
    loss='binary_crossentropy', # 0/1 sÄ±nÄ±flandÄ±rma iÃ§in
    metrics=['accuracy'] # doÄŸruluk oranÄ±nÄ± takip et
)

from sklearn.utils import class_weight
import numpy as np

# SÄ±nÄ±f aÄŸÄ±rlÄ±klarÄ±nÄ± otomatik hesapla
weights = class_weight.compute_class_weight(
    class_weight='balanced',
    classes=np.unique(y_train),
    y=y_train
)

# SÃ¶zlÃ¼k haline getir
class_weights = {0: weights[0], 1: weights[1]}

print("SÄ±nÄ±f aÄŸÄ±rlÄ±klarÄ±:", class_weights)

#Model EÄŸitimi

history = model.fit(
    X_train_scaled,
    y_train,
    epochs=20,
    batch_size=32,
    validation_split=0.1,
    verbose=1,
    class_weight=class_weights   # ğŸŸ¢  burasÄ± eklendi
)

#DoÄŸruluk GÃ¶rselleÅŸtirme

import matplotlib.pyplot as plt

plt.plot(history.history['accuracy'],label='EÄŸitim')
plt.plot(history.history['val_accuracy'],label='DoÄŸrulama')
plt.title('Model DoÄŸruluÄŸu')
plt.ylabel('DoÄŸruluk')
plt.xlabel('Epoch')
plt.legend()
plt.grid()
plt.show()

#Modeli Test Etme

from sklearn.metrics import accuracy_score, confusion_matrix, classification_report

y_pred_prob=model.predict(X_test_scaled)
y_pred= (y_pred_prob>0.5).astype(int)
#tahminler 0.5 Ã¼stÃ¼ ise 1 kabul etmek iÃ§in

print("Test DoÄŸruluÄŸu:",accuracy_score(y_test,y_pred))
print("Confusion Matrix:\n",confusion_matrix(y_test,y_pred))
print("Classification Report:\n",classification_report(y_test,y_pred))

"""
Modelin doÄŸruluk oranÄ± yÃ¼ksek %88 ancak veri
Recall Ã§ok dÃ¼ÅŸÃ¼k â†’ Yani gerÃ§ek riskli mÃ¼ÅŸterileri yakalayamÄ±yor

F1-score = 0.09 â†’ Bu sÄ±nÄ±f iÃ§in model baÅŸarÄ±sÄ±z

bunun iÃ§in class weight aÄŸÄ±rlÄ±ÄŸÄ±nÄ± kullnÄ±p tekrar model eÄŸitimi yapcaÄŸÄ±z

Bu sayede model az sayÄ±da bulunan riskli mÃ¼ÅŸterilere Ã¶zen gÃ¶sterecek

"""

#class weight ekledikten sonra accuracy dÃ¼ÅŸtÃ¼ ancak daha gÃ¼venilir bir model elde ettik
#Ã§Ã¼nkÃ¼ model artÄ±k her ÅŸeye 1 demiyor riskli mÃ¼ÅŸterileri daha az kaÃ§Ä±rÄ±yor